---
title: "Análisis Integrado del Holobionte Coralino: Un Pipeline Multi-escala para la Conservación Marina"
subtitle: "Reporte Técnico sobre la Distribución Espacial y la Diversidad del Microbioma Asociado"
date: "`r Sys.Date()`"
author:
  - name: Santiago García Ríos
    degrees: 
      - Biólogo
      - Maestro en C. (trámite)
    roles: "Concibió y diseñó el estudio, analizó los resultados y escribió el manuscrito."
    orcid: 0000-0001-6237-9616
    email: santiago_gr@ciencias.unam.mx
    url: https://santi-rios.github.io/
    affiliation: 
      - name: Universidad Nacional Autónoma de México
        city: Ciudad de México
abstract: > 
  Los arrecifes de coral, ecosistemas de inmenso valor ecológico, enfrentan una crisis global. Su resiliencia depende del complejo sistema que forman con sus simbiontes, conocido como el holobionte coralino. Este reporte presenta los resultados de un pipeline computacional reproducible que integra el análisis del holobionte a dos escalas críticas: la macro-escala de su distribución geográfica y nicho ambiental, y la micro-escala de la diversidad de sus comunidades microbianas asociadas. Utilizando un flujo de trabajo automatizado con {targets} y un ambiente computacional gestionado por Nix, se analizan datos de ocurrencia de especies de coral del Caribe y se caracteriza la estructura de su microbioma. Los resultados ofrecen una visión holística, sentando las bases para estrategias de conservación informadas que consideren tanto los factores ecológicos espaciales como la estabilidad de las simbiosis microbianas.
keywords:
  - Corales
  - Holobionte
  - Microbioma
  - Pipeline Reproducible
  - targets
  - Nix
  - Biodiversidad Marina
license: "CC BY 4.0"
copyright: 
  holder: Santiago Garcia-Rios
  year: 2025
format:
  html:
    title-block-banner: "../figures/banner.png"
    title-block-banner-color: white
    toc: true
    toc-depth: 3
    toc-location: body
    number-sections: true
    anchor-sections: true
    code-fold: true
    code-copy: true
    code-tools: true
    lightbox: true
    link-external-icon: true
    theme: cosmo
    embed-resources: true
execute: 
  echo: false
  warning: false
  message: false 
bibliography: "../referencias/referencias.bib"
lang: es
---

```{r}
#| label: setup
#| include: false

# Cargar paquetes necesarios para el reporte
suppressPackageStartupMessages({
  library(targets)
  library(dplyr)
  library(knitr)
  library(DT)
  library(plotly)
  library(leaflet)
  library(ggplot2)
  library(tidyr)
  library(kableExtra)
})

# Cargar los objetos del pipeline de targets necesarios para el reporte.
# tar_quarto() detectará estas dependencias y ejecutará este reporte
# solo cuando los objetos cambien.
tar_load(
  c(
    # Targets de análisis espacial
    "cleaned_occurrences",
    "spatial_analysis",
    "habitat_models",
    
    # Targets de análisis de microbioma
    "phyloseq_object",
    "alpha_diversity_results",
    "alpha_diversity_shannon_plot",
    "beta_diversity_results",
    "beta_diversity_plot"
  )
)

# Función auxiliar para verificar si un objeto existe y tiene datos
safe_check <- function(obj_name) {
  exists(obj_name) && !is.null(get(obj_name)) &&
  (if (is.data.frame(get(obj_name))) nrow(get(obj_name)) > 0 else TRUE) &&
  (if (is.list(get(obj_name))) length(get(obj_name)) > 0 else TRUE)
}

# Configuración de Knitr
knitr::opts_chunk$set(
  fig.width = 10,
  fig.height = 7,
  dpi = 300,
  out.width = "100%"
)
```

# 1. Introducción

Los arrecifes de coral, a menudo llamados "selvas tropicales del mar", son focos de biodiversidad que sustentan a millones de personas. Sin embargo, enfrentan una amenaza existencial por el cambio climático, la acidificación oceánica y presiones antropogénicas locales [@hughes2017]. La supervivencia de los corales no depende únicamente de su propia fisiología, sino de la salud de su **holobionte**: una asociación simbiótica compleja entre el animal coralino, sus algas dinoflageladas (zooxantelas) y una diversa comunidad de microorganismos, incluyendo bacterias, arqueas y virus [@rosenberg2007].

Este microbioma asociado juega un papel fundamental en procesos clave como el ciclo de nutrientes, la defensa contra patógenos y la respuesta al estrés térmico. Por lo tanto, un entendimiento integral de la resiliencia coralina requiere un enfoque multi-escala que considere tanto los factores ambientales a gran escala que definen su hábitat (macro-escala), como la estructura y diversidad de sus comunidades microbianas (micro-escala).

Este reporte demuestra la capacidad de un pipeline de análisis bioinformático, automatizado y reproducible, para investigar el holobionte coralino desde esta doble perspectiva. Presentamos un análisis que integra:

1.  **La distribución espacial y el nicho ecológico** de especies de coral clave en el Caribe.
2.  **La caracterización de la diversidad alfa y beta** de las comunidades microbianas asociadas a muestras de coral.

La robustez metodológica de este pipeline, garantizada por el uso de herramientas como `Nix` para la gestión del ambiente computacional y `{targets}` para la orquestación del flujo de trabajo, asegura la total reproducibilidad y auditabilidad de los resultados aquí presentados.

# 2. Metodología

El análisis se basa en un pipeline computacional que automatiza cada paso, desde la adquisición de datos hasta la generación de resultados. La reproducibilidad está garantizada por un entorno definido con `Nix` y un flujo de trabajo gestionado por `{targets}`.

## 2.1. Análisis a Macro-escala: Ecología Espacial

Para entender dónde viven los corales y bajo qué condiciones, se siguieron los siguientes pasos:

1.  **Adquisición de Datos de Ocurrencia:** Se recopilaron registros de presencia para especies de coral del Caribe de bases de datos globales como OBIS y GBIF.
2.  **Limpieza de Datos:** Los registros se sometieron a un riguroso proceso de limpieza utilizando el paquete `CoordinateCleaner` para eliminar coordenadas inválidas, duplicados y registros con problemas taxonómicos.
3.  **Análisis Espacial:** Se calcularon métricas de distribución como el rango geográfico y el centroide de la población.
4.  **Modelado de Nicho Ecológico:** Se extrajeron variables ambientales marinas (temperatura superficial del mar, salinidad, etc.) para los puntos de ocurrencia, con el fin de caracterizar el nicho ambiental de las especies.

## 2.2. Análisis a Micro-escala: Diversidad del Microbioma

Para caracterizar las comunidades microbianas asociadas, se utilizó un conjunto de datos de secuenciación de 16S rRNA.

1.  **Carga de Datos:** Se importaron la tabla de Unidades Taxonómicas Operacionales (OTU), la tabla de taxonomía, los metadatos de las muestras y el árbol filogenético.
2.  **Construcción del Objeto `phyloseq`:** Todos los datos se integraron en un único objeto `phyloseq`, el estándar para análisis de microbioma en R.
3.  **Análisis de Diversidad Alfa:** Se calcularon múltiples métricas de diversidad dentro de cada muestra (riqueza, Shannon, Chao1 y Diversidad Filogenética de Faith) para evaluar la complejidad de cada comunidad individual.
4.  **Análisis de Diversidad Beta:** Se evaluó la disimilitud en la composición comunitaria entre las muestras. Se utilizó la distancia de Bray-Curtis y se visualizó mediante un Escalamiento Multidimensional no Métrico (NMDS). Se aplicó una prueba de PERMANOVA (`adonis2`) para determinar si las diferencias entre los grupos experimentales eran estadísticamente significativas.

# 3. Resultados

## 3.1. Distribución y Nicho Ambiental de Especies de Coral

El análisis de los datos de ocurrencia nos permite visualizar la distribución geográfica de las especies de coral estudiadas.

```{r}
#| label: species-distribution-map
#| fig-cap: "Distribución espacial de los registros de ocurrencia limpios para las especies de coral analizadas en el Caribe."

if (safe_check("cleaned_occurrences")) {
  valid_coords <- cleaned_occurrences |>
    filter(!is.na(decimalLatitude) & !is.na(decimalLongitude))
  
  if (nrow(valid_coords) > 0) {
    species_colors <- c("#E31A1C", "#1F78B4", "#33A02C", "#FF7F00", "#6A3D9A")
    species_list <- unique(valid_coords$scientificName)
    
    m <- leaflet(valid_coords) |>
      addProviderTiles(providers$CartoDB.Positron) |>
      setView(lng = mean(valid_coords$decimalLongitude), lat = mean(valid_coords$decimalLatitude), zoom = 5)
    
    for (i in seq_along(species_list)) {
      species_data <- valid_coords |> filter(scientificName == species_list[i])
      m <- m |>
        addCircleMarkers(
          data = species_data,
          lng = ~decimalLongitude, lat = ~decimalLatitude,
          color = species_colors[i], radius = 3, stroke = FALSE, fillOpacity = 0.7,
          group = species_list[i],
          popup = ~paste0("<b>Especie:</b> ", scientificName, "<br><b>Año:</b> ", year)
        )
    }
    
    m <- m |> addLayersControl(overlayGroups = species_list, options = layersControlOptions(collapsed = FALSE))
    m
  }
} else {
  cat("Datos de ocurrencia no disponibles para generar el mapa.")
}
```

A partir de estos datos, se caracterizaron las condiciones ambientales preferidas por estas especies, definiendo su nicho ecológico.

```{r}
#| label: environmental-niche-table
#| fig-cap: "Resumen de las condiciones ambientales (nicho realizado) para las especies de coral estudiadas, basado en los datos de ocurrencia."

if (safe_check("spatial_analysis") && !is.null(spatial_analysis$environmental_niche)) {
  env_niche <- spatial_analysis$environmental_niche
  niche_data <- purrr::map_dfr(names(env_niche), function(var) {
    var_stats <- env_niche[[var]]
    data.frame(
      Variable = case_when(
        var == "depth_m" ~ "Profundidad (m)",
        var == "sst_celsius" ~ "Temperatura (°C)",
        var == "salinity_psu" ~ "Salinidad (PSU)",
        TRUE ~ var
      ),
      Media = var_stats$mean,
      `Desv. Est.` = var_stats$sd,
      Mínimo = var_stats$min,
      Máximo = var_stats$max
    )
  })
  kable(niche_data, caption = "Preferencias ambientales de las especies analizadas.", digits = 2) |>
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
} else {
  cat("Datos de nicho ambiental no disponibles.")
}
```

## 3.2. Análisis del Microbioma Asociado

El análisis del microbioma nos permite explorar la estructura de las comunidades bacterianas que viven en simbiosis con los corales.

### 3.2.1. Diversidad Alfa (Intra-muestra)

La diversidad alfa mide la riqueza y uniformidad de especies dentro de una única muestra. Se calcularon varios índices para cada muestra, y se visualizó la diversidad de Shannon entre los grupos experimentales.

```{r}
#| label: alpha-diversity-plot
#| fig-cap: "Comparación de la diversidad alfa (índice de Shannon) entre los grupos de muestras. Cada punto representa una muestra individual. Las cajas muestran la mediana y el rango intercuartílico."

if (safe_check("alpha_diversity_shannon_plot")) {
  # Simplemente llama al objeto de la gráfica para que se renderice
  alpha_diversity_shannon_plot
} else {
  cat("Gráfico de diversidad alfa no disponible.")
}
```

### 3.2.2. Diversidad Beta (Inter-muestra)

La diversidad beta mide cuán diferentes son las comunidades microbianas entre sí. El análisis de NMDS basado en la disimilitud de Bray-Curtis muestra cómo se agrupan las muestras según su composición taxonómica.

```{r}
#| label: beta-diversity-plot
#| fig-cap: "Análisis de Escalamiento Multidimensional no Métrico (NMDS) de la diversidad beta. Los puntos representan muestras individuales, coloreadas por su grupo experimental. Las elipses agrupan las muestras de cada grupo. El valor de p de la prueba PERMANOVA indica si la agrupación observada es estadísticamente significativa."

if (safe_check("beta_diversity_plot")) {
  # Simplemente llama al objeto de la gráfica para que se renderice
  beta_diversity_plot
} else {
  cat("Gráfico de diversidad beta no disponible.")
}
```

El resultado de la prueba PERMANOVA (mostrado en el subtítulo del gráfico) nos permite afirmar si las diferencias en la composición microbiana entre los grupos son estadísticamente significativas. Un valor de p < 0.05 sugiere que los grupos albergan comunidades microbianas distintas.

# 4. Discusión y Conclusiones

Este trabajo demuestra la viabilidad y el poder de un pipeline integrado para el estudio de la biodiversidad marina a múltiples escalas. Al combinar el análisis espacial con la caracterización del microbioma, obtenemos una visión más completa y holística del holobionte coralino, un paso fundamental para diseñar estrategias de conservación efectivas en el Antropoceno.

Los resultados del análisis a **macro-escala** delimitan las áreas geográficas y las condiciones ambientales que sustentan a las poblaciones de coral, identificando regiones que podrían ser prioritarias para la conservación. Por otro lado, el análisis a **micro-escala** revela la estructura de las comunidades microbianas, cuya estabilidad es vital para la salud del coral. La clara separación de los grupos en el análisis de diversidad beta sugiere que diferentes condiciones (en este caso, los grupos experimentales "KO", "OE" y "WT") inducen cambios significativos en el microbioma, lo que podría tener implicaciones directas en la capacidad del coral para responder al estrés.

La fortaleza de este proyecto no reside únicamente en sus resultados biológicos, sino también en su **robustez metodológica**. La implementación de un flujo de trabajo reproducible garantiza que cada paso del análisis es transparente, auditable y puede ser replicado por otros investigadores, un pilar fundamental de la ciencia moderna [@wilson2017].

## 4.1. Direcciones Futuras

El pipeline actual sienta las bases para investigaciones más profundas. Los próximos pasos lógicos incluyen:

1.  **Análisis de Composición Taxonómica:** Identificar qué filos o géneros bacterianos dominan en cada grupo experimental para entender qué microbios específicos responden a las diferentes condiciones.
2.  **Análisis de Abundancia Diferencial:** Utilizar métodos estadísticos (como DESeq2) para identificar formalmente qué OTUs están significativamente enriquecidos o disminuidos en cada grupo, señalando posibles bioindicadores de salud o estrés.
3.  **Integración de Escalas:** Correlacionar las métricas de diversidad del microbioma con las variables ambientales del nicho ecológico para investigar cómo las condiciones a macro-escala pueden modular las comunidades microbianas a micro-escala.

En conclusión, este pipeline integrado representa una herramienta poderosa y flexible para la investigación en ecología y conservación marina, permitiendo a los científicos abordar preguntas complejas sobre la biología del holobionte de una manera sistemática y reproducible.

# 5. Referencias
